#!/bin/sh
#
# watcher

event() {
    . fwmrc
    wmenv
    wmgaps

    wew | while read -r ev wid args; do
        case "$ev" in
            CREATE)
                wattr o "$wid" || {
                    case "$(atomx "$wid" WM_CLASS)" in
                        # kill compositing when game is running
                        steam_app_*|Wine)
                            pkill picom 2> /dev/null
                            printf '%s\n' "$wid" >> "$fwmdir/picom"
                            full "$wid" "$PRI"
                            ;;
                        # fix for qutebrowser fixed position
                        qutebrowser)
                            for window in $(lsw | grep -v "$wid"); do
                                atomx "$window" WM_CLASS
                            done | grep -q "qutebrowser" && {
                                wmv -a $(wmp -a) "$wid"
                            }
                            ;;
                    esac

                    # autogroups
                    while read -r line; do
                        class="$(atomx "$wid" WM_CLASS)"
                        matchedClass="$(printf '%s\n' "$line" | cut -d\  -f 1)"

                        test "$class" = "$matchedClass" && {
                            group="$(printf '%s\n' "$line" | cut -d\  -f 2)"
                            group -a "$group" "$wid"
                        }
                    done < "$HOME/.autogroup"
                }
                ;;
            DESTROY)
                full -c "$wid"
                group -c "$wid"

                # clean picom
                grep -q "$wid" "$fwmdir/picom" > /dev/null 2>&1 && {
                    pgrep picom > /dev/null 2>&1 || picom &
                    cleaned="$(grep -v "$wid" "$fwmdir/picom")"
                    printf '%s' "$cleaned" > "$fwmdir/picom"
                }
                ;;
        esac
    done
}

event
