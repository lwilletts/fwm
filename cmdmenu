#!/bin/sh
# shellcheck disable=SC2015,SC2046
#
# cmdmenu

usage() {
    base=$(basename "$0")

    cat >&2 << EOF
Usage:
    $ $base
EOF

    test $# -eq 0 || exit "$1"
}

sel() {
    sleep 0.2
    wid="$(slw)"

    test "$wid" = "0x00000000" && exit 0

    case "$1" in
        shot)   shot "$wid"                  ;;
        delete) killw "$wid"                 ;;
        term)   killw -p "$wid"              ;;
        resize) chwso -r "$wid"; xmrs "$wid" ;;
        move)   chwso -r "$wid"; xmmv "$wid" ;;
        place)  chwso -r "$wid"; sh -c "wtp $(xrectsel '%x %y %w %h') $wid" ;;
    esac
}

new() {
    sleep 0.2

    fw=5
    fh=10
    ib=10
    ob=2

    xrectsel '%w %h %x %y' | {
            read -r w h x y
            w=$(( ( w - (ib + ob)*2 ) / fw ))
            h=$(( ( h - (ib + ob)*2 ) / fh ))
            exec urxvtc -g "${w}x${h}+${x}+${y}"
    }
}

open() {
    # use link handling program of your choosing
    load "$(xsel -o)"
}

main() {
    . fwmrc
    wmenv
    wmgaps
    wmcolours

    case "$1" in
        -h|--help|help) usage 0 ;;
    esac

    FONT=$(awk '/font/ {print $3}' < ~/.Xresources | cut -d',' -f 1)

    # menu geometry fit to display
    SCR="$(pfm)"
    X0="$(mattr x "$SCR")"
    Y0="$(mattr y "$SCR")"
    X=$(($(wmp | cut -d\  -f 1) - X0))
    Y=$(($(wmp | cut -d\  -f 2) - Y0))

    W="100"
    FH="15"
    L="$(printf '%s\n' "$processes" | wc -l)"
    H="$((FH * (L + 1)))"

    test "$X" -lt "$LGAP" && X="$((LGAP + X0))"
    test "$Y" -lt "$TGAP" && Y="$((TGAP + Y0))"

    Xboundary="$(($(mattr w "$SCR") - W - RGAP))"
    test "$X" -gt "$Xboundary" && X=$Xboundary

    Yboundary="$(($(mattr h "$SCR") - H - BGAP))"
    test "$Y" -gt "$Yboundary" && Y=$Yboundary

    wmp -a "$((X + X0 + 15))" "$((Y + Y0 + 20))"

    process=$(printf '%s\n' "$processes" | \
dmenu -name "cmdmenu" -f -l "$L" -fn "$FONT" -p " Do >" \
-nf "#$ACTIVE" -sf "#$INACTIVE" -nb "#$INACTIVE" -sb "#$URGENT" -bc "#$ACTIVE" \
-s "$(mattr d "$(pfm)")" -x $X -y $Y -w "$W" -h "$FH" -bw $BW)

    case "$process" in
        new)       new                ;;
        ssh)       sshmenu            ;;
        move)      sel move           ;;
        place)     sel place          ;;
        launch)    lmenu              ;;
        select)    wmenu -m           ;;
        resize)    sel resize         ;;
        delete)    sel delete         ;;
        terminate) sel term           ;;
        copy)      xsel -ob | xsel -i ;;
        open)      open               ;;
        shot)      shot               ;;
        pfw)       sel shot           ;;
        off)       poweroff           ;;
    esac
}

main "$@"
