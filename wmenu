#!/bin/sh
#
# wmenu

usage() {
    base=$(basename $0)

    cat >&2 << EOF
Usage:
    $base                Select visible windows.
    $base -a | all:      Select all windows.
    $base -u | unmapped: Select only unmapped windows.
    $base -h | help:     Show this help.
EOF

    test $# -eq 0 || exit $1
}

menu() {
    # CWM-like right click
    X=$(($(wmp | cut -d\  -f 1) - $(mattr x $PRI) - 10))
    Y=$(($(wmp | cut -d\  -f 2) - $(mattr y $PRI) - 10))

    wid="$(for window in $($LSWCMD); do
               printf '%s\n' "$window $(class $window) | $(wname $window)"
           done | sort -k 2 | \
           dmenu -name "wmenu" -f -l $LINES -s 0 -i -fn $FONT -p "Window >" \
           -nf "#$ACTIVE" -sf "#$URGENT" -nb "#$INACTIVE" -sb "#$INACTIVE" -bc "#$ACTIVE" \
           -x $X -y $Y -w "400" -bw 1 | cut -d\  -f 1)"
}

bar() {
    wid="$(for window in $($LSWCMD); do
               printf '%s\n' "$window $(class $window) | $(wname $window)"
           done | \
           dmenu -name "wmenu" -f -l $LINES -s 0 -i -fn $FONT -p "Window >" \
           -nf "#$ACTIVE" -sf "#$URGENT" -nb "#$INACTIVE" -sb "#$INACTIVE" -bc "#$ACTIVE" \
           -bw 1 | cut -d\  -f 1)"
}

main() {
    . fwmrc
    wmenv
    wmgaps
    wmcolours

    FONT=$(awk '/font/ {print $3}' < ~/.Xresources | cut -d',' -f 1)

    LSWCMD="lsw"

    LINES=$($LSWCMD | wc -l)
    test $LINES -eq 0 && exit 1

    case "$1" in
        -b) bar ;;
        *) menu ;;
    esac

    # always ensure focus and stack order
    wtf "$wid"
    chwso -r "$wid"

    focus -w "$wid"
}

main "$@"
